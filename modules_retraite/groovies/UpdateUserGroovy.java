import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class MapGroovy {

	final static Log log = LogFactory.getLog(MapGroovy.class);

	static {
		java.util.Map<String, String> rubricMap = new java.util.HashMap<String, String>();
		rubricMap.put("1939d8e7-48fb-4360-80a3-1e7079e7d0ff", "c1788685-a575-4d19-9d2f-5efa05b7d44d");
		rubricMap.put("cd9690f2-0433-416f-bd93-157b30e92a7c", "4c7aa70e-807e-4c2f-87e2-269a0ebccfba");
		rubricMap.put("396190e0-b73d-405e-9682-0624c56b3034", "c5c539f3-0afa-45b6-9a7f-0d48e2f8c20d");
		rubricMap.put("76686aa8-d1c9-4c6e-a6b4-4882061167cb", "db718c6b-3582-4ad0-9e0f-216d9473a940");
		rubricMap.put("04c7eaf7-6e83-4ef8-b09e-ae039073203a", "099e4e6f-cab8-4a3a-9906-c8c953efa4cf");
		rubricMap.put("badc3c9f-542c-446a-a12a-0768298354e7", "059c62f4-d413-4536-bdc2-7e2afc1c7638");

		java.util.Map<String, String> thematicMap = new java.util.HashMap<String, String>();
		thematicMap.put("8e03dbb8-a36b-4bac-9886-3b42b0d7558e", "dd9cbcc7-eefc-4edb-8bf5-4a62f59d431c");
		thematicMap.put("44325f97-5b65-4ac0-9d66-5e0c7a0d34f3", "02c865e8-4c35-43a1-836c-889a35e4d222");
		thematicMap.put("a4206a55-8d24-427a-a682-3d919ac07805", "2427de03-12eb-4912-8bc2-a51fc1050635");
		thematicMap.put("cc890b9b-b8b0-4640-8bc6-ca2a8c3ee2a2", "00cf93b5-088f-4b3a-bdc2-57b5de39feed");
		thematicMap.put("18d1dcb0-f754-4943-9416-2f9c38ed4620", "e4623b8a-e621-4c16-b2ab-b081576cbf8a");
		thematicMap.put("d5de27e4-8145-47f4-8e70-c96037a3a8f8", "393bec35-1e13-4b96-a739-abe278d307d2");
		thematicMap.put("22cc68cc-db17-444f-a635-9b4aa777a551", "f26d9ab8-ca1d-4bfe-94ea-f0ad6f489bae");
		thematicMap.put("6adc665f-d45c-4222-8b7d-d916da3959e7", "8284b190-fb80-4f67-b2c5-f503d63eebf7");
		thematicMap.put("0af38762-a8e8-4dee-b8ad-9154dd61147b", "bf6114b9-bbba-4be6-8e39-3aebb497e78e");
		thematicMap.put("33bd44a9-5023-4dec-a466-d4c866ad03b4", "1b180509-d4d2-4856-a7ac-e3c307b64de5");
		thematicMap.put("368b1b0b-e02c-4141-9f77-70b6b82892dc", "7ad9246f-ec60-4092-b409-d45ec5ecc658");
		thematicMap.put("28cce3cb-f3b2-4f5a-b331-dba1351ec8d0", "14d3c48d-85ee-43a7-99ec-697ccce67819");
		thematicMap.put("1fd38283-a188-452e-8ad8-1e0c581b68ba", "793939e9-0024-4a65-a612-44b686f0e222");
		thematicMap.put("8c8b54bf-e6ea-41bf-86df-148e409945b7", "c62c314e-bcaa-4c2e-8fc1-e530740a288d");
		thematicMap.put("70df26f2-3d34-4488-a859-9d68c32e39af", "9fa35ab2-5d4a-4e64-b7ad-bd584fbfd8da");
		thematicMap.put("c1e17bc6-2b21-4870-8742-c1390db72daa", "136a41d5-9195-48d2-97db-889847564845");
		thematicMap.put("58078a67-e575-4705-af8f-ea2d153b5f74", "fd95beb9-b4d5-451b-bb06-ddfd83c8e4c8");
		thematicMap.put("97a5ea0e-a841-4fab-baa2-845e01acd6f2", "f6d839b8-941f-4ed8-986a-7a29978c3282");
		thematicMap.put("c0d4e51c-08e9-4a14-bc87-3bb83b0c9283", "3c6986cd-1619-44ac-9562-ddcdeb502cc5");
		thematicMap.put("644e3353-6f27-470a-9c82-dc6ef7560a77", "129cbdab-0bbb-42fd-9449-b523fdc1d8b6");
		thematicMap.put("05ddd606-b59e-4169-8bfd-1bd8583a9f52", "007e1178-2733-48a6-8002-0fbdb5090cdb");
		thematicMap.put("c7f7d806-1776-4ecd-ab95-73ceaa180b68", "4fba3bd2-da8d-4334-840b-e6d835958129");
		thematicMap.put("d0fe52a3-e400-4f05-b600-e1d40fdfcd25", "7bc2f9cf-ba1b-401b-9ae3-527d67a39271");
		thematicMap.put("e8fb28ac-a500-40cf-b183-e6e80cc9158f", "4b6132fc-b93b-4d5e-b1b1-7e0e489382f3");
		thematicMap.put("ad3e1266-657a-43ed-ab9c-a9061d8a8a1e", "1eef5ebe-9562-4599-8d5c-6a036b104819");
		thematicMap.put("937b08e6-5f90-4440-b15e-713e7b8991f2", "f681a207-6e2a-4576-8f5b-5ce81dbfca2c");
		thematicMap.put("4b1f0eb7-addd-474c-90b4-ddaed285660e", "add6bf0b-cb7a-487e-be9a-1ab307cde107");
		thematicMap.put("354cdedd-2bcd-4740-b024-0968ef851fd0", "9e3c7df1-1319-40bd-90a9-233fd4efd18a");
		thematicMap.put("4e0de4b4-fa11-4bfd-b914-ed6ecb56bae2", "d54d5536-a74a-4b0f-8139-c696c635f023");
		thematicMap.put("c0ce8ca3-e81a-458d-8d44-c7ba931bb459", "ef6eb800-ad12-4c0c-80f6-d4a9a6036c2c");
		thematicMap.put("862116e5-97fd-4cad-ad0f-0567ceb65e05", "15c99d54-bee2-4b9b-b7dd-cfc1f2398d93");
		thematicMap.put("c6d00c17-9d37-4adf-9fde-410d3de96666", "a4ddde7d-120d-4667-91ec-c2c2fde7ab6f");
		thematicMap.put("a0223893-f4cd-4f52-a6c2-feb62209852b", "37a72688-2a9d-4769-bb63-3c96fe0d46c9");
		thematicMap.put("d920dc72-ba50-4c90-9ed2-68aaad56639c", "facc8bf6-7045-4546-a000-778b33dd6e15");

		log.info("//////\n// GROOVY RUBRIC \n////////");
		try {
			org.jahia.services.content.JCRSessionWrapper session = org.jahia.services.content.JCRSessionFactory.getInstance()
					.getCurrentUserSession("default");
			javax.jcr.query.QueryManager queryManager = session.getWorkspace().getQueryManager();
			final String prefRubricProp = org.commons.util.CiConstants.PROPERTIES_USER_SELECTED_RUBRICS;
			String query = "SELECT * FROM [jnt:user] WHERE " + prefRubricProp + "<>''";

			javax.jcr.query.Query q = queryManager.createQuery(query.toString(), javax.jcr.query.Query.JCR_SQL2);
			javax.jcr.query.QueryResult queryResult = q.execute();
			javax.jcr.NodeIterator iterator = queryResult.getNodes();

			int countRub = 0;

			while (iterator.hasNext()) {
				java.util.List<String> newPrefs = new java.util.ArrayList<String>();
				final org.jahia.services.content.JCRNodeWrapper n = (org.jahia.services.content.JCRNodeWrapper) iterator.next();
				String propertyValue = n.getPropertyAsString(prefRubricProp);

				if (org.commons.util.Validator.isNotEmpty(propertyValue)) {
					String[] array = propertyValue.split(",");
					for (String uuid : array) {
						if (org.commons.util.Validator.isNotEmpty(rubricMap.get(uuid)))
							newPrefs.add(rubricMap.get(uuid));
						else
							newPrefs.add(uuid);
					}
				}
				if (!newPrefs.isEmpty()) {
					String prop = org.apache.commons.lang.StringUtils.join(newPrefs.toArray(), ",");
					n.setProperty(prefRubricProp, prop);
					session.save();
					countRub++;
				}
			}

			log.info("Changed " + countRub + " user prefered rubrics");
		} catch (javax.jcr.query.InvalidQueryException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (javax.jcr.RepositoryException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		log.info("//////\n// GROOVY THEMATIC \n////////");

		try {
			org.jahia.services.content.JCRSessionWrapper session = org.jahia.services.content.JCRSessionFactory.getInstance()
					.getCurrentUserSession("default");
			javax.jcr.query.QueryManager queryManager = session.getWorkspace().getQueryManager();
			final String prefThematicProp = org.commons.util.CiConstants.PROPERTIES_USER_SELECTED_THEMATICS;
			String query = "SELECT * FROM [jnt:user] WHERE " + prefThematicProp + "<>''";

			javax.jcr.query.Query q = queryManager.createQuery(query.toString(), javax.jcr.query.Query.JCR_SQL2);
			javax.jcr.query.QueryResult queryResult = q.execute();
			javax.jcr.NodeIterator iterator = queryResult.getNodes();

			int countThem = 0;

			while (iterator.hasNext()) {
				final org.jahia.services.content.JCRNodeWrapper n = (org.jahia.services.content.JCRNodeWrapper) iterator.next();
				String propertyValue = n.getPropertyAsString(prefThematicProp);
				java.util.List<String> newPrefs = new java.util.ArrayList<String>();

				if (org.commons.util.Validator.isNotEmpty(propertyValue)) {
					String[] array = propertyValue.split(",");
					for (String uuid : array) {
						if (org.commons.util.Validator.isNotEmpty(thematicMap.get(uuid)))
							newPrefs.add(thematicMap.get(uuid));
						else
							newPrefs.add(uuid);
					}
				}

				if (!newPrefs.isEmpty()) {
					String prop = org.apache.commons.lang.StringUtils.join(newPrefs.toArray(), ",");
					n.setProperty(prefThematicProp, prop);
					session.save();
					countThem++;
				}
			}
			log.info("Changed " + countThem + " user prefered thematics");

		} catch (javax.jcr.query.InvalidQueryException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (javax.jcr.RepositoryException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

	}
}
